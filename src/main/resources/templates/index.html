<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />
<title th:text="${titulo}"></title>
<link rel="stylesheet" href="./css/bootstrap.css">
<script src="https://code.jquery.com/jquery-3.3.1.js"></script>
</head>
<body>
	<h1>Spring boot Softtek</h1>
	<div class="container">
		<div class="jumbotron">
			<h1>Registra Usuarios</h1>
		</div>
		<div class="container">
			<div class="card">
				<div class="card-body">
					<form>
						<!--  th:action="@{/index}" method="post" -->
						<div>
							<label for="nombre">Nombre Usuario </label>
							<div>
								<input type="text" name="nombre" id="nombre"
									class="input form-control" required>
							</div>
							<div th:if="${error != null && error.containsKey(nombre)}"
								th:text="${error.nombre}"></div>
						</div>

						<div>
							<label for="correo">Correo Usuario</label>
							<div>
								<input type="email" name="email" id="email"
									class="input form-control">
							</div>
						</div>

						<div>

							<div>
								<label for="estatus">Estatus:</label> <select name="estatus"
									id="estatus">
									<option value="ACTIVO">ACTIVO</option>
									<option value="INACTIVO">INACTIVO</option>
									<option value="SUSPENDIDO">SUSPENDIDO</option>
								</select>
							</div>

						</div>


						<div class="form-group col-md-6">
							<button type="button" id="btn-submit" class="btn btn-primary"
								onclick="validarInputs();">Enviar</button>

							<!--<input type="submit" value="Enviar">-->
						</div>
						<div class="form-group col-md-6">
							<a href="http://localhost:8080/exportarReporte"
								class="btn btn-primary">Exportar PDF</a>
							<!--<input type="submit" value="Enviar">-->
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>


	<div class="container">
		<table id="tableUsuarios" class="table table-bordered table-striped">
			<thead clas="thead-light">
				<tr>
					<th scope="coll">ID</th>
					<th scope="coll">Email</th>
					<th scope="coll">Nombre</th>
					<th scope="coll">Estatus</th>
					<th scope="coll">Fecha y Hora</th>

				</tr>
			</thead>
			<tbody>

			</tbody>
		</table>
	</div>
</body>

<script type="text/javascript">
	$(document).ready(function() {
		TablaUsuarios()
	});

	function registroUsuario() {
		var nombre;
		var email;
		var estatus;
		var datos = {
			nombre : document.getElementById("nombre").value,
			email : document.getElementById("email").value,
			estatus : document.getElementById("estatus").value,
		};
		$.ajax({
			type : "POST",
			contentType : "application/json",
			//dataType : 'json',
			url : "postRegistrarUsuario",
			data : JSON.stringify(datos),
			success : function(response) {
				TablaUsuarios();
				$(".input").val("");
			},
			error : function() {

			},
			async : true,
			cache : false
		});

	}
	function TablaUsuarios() {

		$
				.ajax({
					url : "/api/reportes/getUsuario",
					data : {},
					success : function(data) {
						var dataJSON = data;
						dataJSON = JSON.parse(dataJSON);
						var tablaUsuario = '';
						if (jQuery.isEmptyObject(dataJSON)) {
							$("#tableUsuarios tbody").html('');
						} else {
							for (var i = 0; i < dataJSON.length; i++) {
								var idTrNombre = "nombre" + dataJSON[i].id;
								var idTrEmail = "email" + dataJSON[i].id;
								var idTrEstatus = "estatus" + dataJSON[i].id;
								var modificaBtn = "botonModificar"
										+ dataJSON[i].id;
								var modificaTd = "tdModificar" + dataJSON[i].id;
								var eliminaBtn = "botonEliminar"
										+ dataJSON[i].id;
								tablaUsuario += '<tr>' + '<td>'
										+ dataJSON[i].id
										+ '</td>'
										+ '<td id='+ idTrNombre +'>'
										+ dataJSON[i].nombre
										+ '</td>'
										+ '<td id='+ idTrEmail +'>'
										+ dataJSON[i].email
										+ '</td>'
										+ '<td id='+ idTrEstatus +'>'
										+ dataJSON[i].estatus
										+ '</td>'
										+ '<td>'
										+ dataJSON[i].fechaDeRegistro.date.year
										+ "/"
										+ dataJSON[i].fechaDeRegistro.date.month
										+ "/"
										+ dataJSON[i].fechaDeRegistro.date.day
										+ " "
										+ dataJSON[i].fechaDeRegistro.time.hour
										+ ":"
										+ dataJSON[i].fechaDeRegistro.time.minute
										+ ":"
										+ dataJSON[i].fechaDeRegistro.time.second
										+ '</td>'
										+ '<td id='+modificaTd+'>'
										+ '<a id="'
										+ modificaBtn
										+ '" class="btn btn-primary" onclick="modificarUsuario(this)" data-value="'
										+ dataJSON[i].id
										+ '">  Editar  </a>'
										+ '</td>'
										+ '<td>'
										+ '<a id="'
										+ eliminaBtn
										+ '" class="btn btn-danger" onclick="eliminarUsuario(this)" data-value="'
										+ dataJSON[i].id + '"> Eliminar </a>'
										+ '</td>'

										+ '</tr>';
								$("#tableUsuarios tbody").html(tablaUsuario);
							}
						}
					},
					error : function() {

					},
					async : true,
					cache : false
				});
	}

	function modificarUsuario(id) {
		var idUsuario = $(id).data('value');
		$
				.ajax({
					url : "/api/reportes/getUsuario",
					data : {},
					success : function(data) {
						var dataJSON = data;
						dataJSON = JSON.parse(dataJSON);
						var tablaUsuarioTr = '';
						if (jQuery.isEmptyObject(dataJSON)) {
							$("#tableUsuarios tbody").html('');
						} else {
							for (var i = 0; i < dataJSON.length; i++) {
								var indice = dataJSON[i].id;
								if (indice == idUsuario) {

									$("#nombre" + idUsuario)
											.html(
													'<input type="text" name="innombre'+idUsuario+'" id="innombre'+idUsuario+'" value="'+dataJSON[i].nombre+'">');
									$("#email" + idUsuario)
											.html(
													'<input type="email" name="inemail'+idUsuario+'" id="inemail'+idUsuario+'" value="'+dataJSON[i].email+'">');
									$("#estatus" + idUsuario)
											.html(
													'<input type="text" name="inestatus'+idUsuario+'" id="inestatus'+idUsuario+'" value="'+dataJSON[i].estatus+'">');
									$("#tdModificar" + idUsuario).html(
											'<a class="btn btn-success" onclick="actualizaUsuario(this);" data-value="'
													+ dataJSON[i].id
													+ '">  Guardar </a>');
									$('#botonEliminar' + idUsuario).attr(
											"disabled", true);

								} else {
									$('#botonModificar' + indice).attr(
											"disabled", true);
									$('#botonEliminar' + indice).attr(
											"disabled", true);
								}

							}
						}
					},
					error : function() {

					},
					async : true,
					cache : false
				});

	}
	function eliminarUsuario(id) {
		var idUsuario = $(id).data('value');
		console.log("Eliminar", idUsuario);
		$.ajax({
			type : "GET",
			url : "eliminarUsuario",
			data : {
				idUsuario : idUsuario
			},
			success : function(data) {
				TablaUsuarios();
			},
			error : function() {

			},
			async : true,
			cache : false
		});

	}

	function actualizaUsuario(id) {
		var idUsuario = $(id).data('value');
		var id;
		var nombre;
		var email;
		var estatus;
		var idNombre = "innombre" + idUsuario;
		var idEmail = "inemail" + idUsuario;
		var idEstatus = "inestatus" + idUsuario;
		console.log("Actualizando....", idNombre, " ", idEmail, " ", idEstatus);

		var datos = {
			id : idUsuario,
			nombre : document.getElementById(idNombre).value,
			email : document.getElementById(idEmail).value,
			estatus : document.getElementById(idEstatus).value
		};
		$.ajax({
			type : "POST",
			contentType : "application/json",
			//dataType : 'json',
			url : "postRegistrarUsuario",
			data : JSON.stringify(datos),
			success : function(response) {
				TablaUsuarios();
				$(".input").val("");
			},
			error : function() {

			},
			async : true,
			cache : false
		});

	}

	function validarInputs() {
		if ($("#nombre").val() == '') {
			$("#nombre").css("background-color", "pink");
			alert("Ingresa nombre completo");
			return false;
		}
		if ($("#email").val().indexOf('@', 0) == -1
				|| $("#email").val().indexOf('.', 0) == -1) {
			$("#email").css("background-color", "pink");

			alert('Ingre un correcto valido.');
			return false;
		}
		$("#nombre").css("background-color", "");
		$("#email").css("background-color", "");
		registroUsuario();

	}
</script>
</html>